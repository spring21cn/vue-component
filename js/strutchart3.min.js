!function(e,t,n){"use strict";t.StrutChart=n()}(0,this,function(){var e=function(e){e.parentElement.removeChild(e)},t=function(e){for(var t=1,n=arguments.length;t<n;t++){var i=arguments[t]||{};for(var s in i){var r=i[s];void 0!==r&&(e[s]=r)}}return e},n=function(e){var t=function(e){return"function"==typeof e||"[object Function]"===Object.prototype.toString.call(e)},n=function(e){var t=Number(e);return isNaN(t)?0:0!==t&&isFinite(t)?(t>0?1:-1)*Math.floor(Math.abs(t)):t},i=Math.pow(2,53)-1,s=function(e){var t=n(e);return Math.min(Math.max(t,0),i)};return function(e){var n=this,i=Object(e);if(null==e)throw new TypeError("Arrayfrom requires an array-like object - not null or undefined");var r,o=arguments.length>1?arguments[1]:void 0;if(void 0!==o){if(!t(o))throw new TypeError("Arrayfrom: when provided, the second argument must be a function");arguments.length>2&&(r=arguments[2])}for(var a,l=s(i.length),d=t(n)?Object(new n(l)):new Array(l),c=0;c<l;)a=i[c],d[c]=o?void 0===r?o(a,c):o.call(r,a,c):a,c+=1;return d.length=l,d}(e)},i=function(n){this._name="StrutChart",Promise.prototype.finally=function(e){var t=this.constructor;return this.then(function(n){return t.resolve(e()).then(function(){return n})},function(n){return t.resolve(e()).then(function(){throw n})})};var i=this,s=t({nodeTitle:"name",nodeId:"id",toggleSiblingsResp:!1,depth:999,chartClass:"",exportButton:!1,exportFilename:"StrutChart",parentNodeSymbol:"fa-users",draggable:!1,direction:"t2b",pan:!1,zoom:!1},n),r=s.data,o=document.createElement("div"),a=document.querySelector(s.chartContainer);if(this.options=s,delete this.options.data,this.chart=o,this.chartContainer=a,o.dataset.options=JSON.stringify(s),o.setAttribute("class","strutchart"+(""!==s.chartClass?" "+s.chartClass:"")+("t2b"!==s.direction?" "+s.direction:"")),"object"==typeof r)this.buildHierarchy(o,s.ajaxURL?r:this._attachRel(r,"00"),0);else if("string"==typeof r&&r.startsWith("#"))this.buildHierarchy(o,this._buildJsonDS(document.querySelector(r).children[0]),0);else{var l=document.createElement("i");l.setAttribute("class","fa fa-circle-o-notch fa-spin spinner"),o.appendChild(l),this._getJSON(r).then(function(e){i.buildHierarchy(o,s.ajaxURL?e:i._attachRel(e,"00"),0)}).catch(function(e){console.error("failed to fetch datasource for StrutChart",e)}).finally(function(){var t=o.querySelector(".spinner");e(t)})}if(o.addEventListener("click",this._clickChart.bind(this)),s.exportButton&&!a.querySelector(".oc-export-btn")){var d=document.createElement("button"),c=document.createElement("a");d.setAttribute("class","oc-export-btn"+(""!==s.chartClass?" "+s.chartClass:"")),d.innerHTML="Export",d.addEventListener("click",this._clickExportButton.bind(this)),c.setAttribute("class","oc-download-btn"+(""!==s.chartClass?" "+s.chartClass:"")),c.setAttribute("download",s.exportFilename+".png"),a.appendChild(d),a.appendChild(c)}s.pan&&(a.style.overflow="hidden",o.addEventListener("mousedown",this._onPanStart.bind(this)),o.addEventListener("touchstart",this._onPanStart.bind(this)),document.body.addEventListener("mouseup",this._onPanEnd.bind(this)),document.body.addEventListener("touchend",this._onPanEnd.bind(this))),s.zoom&&(a.addEventListener("wheel",this._onWheeling.bind(this)),a.addEventListener("touchstart",this._onTouchStart.bind(this)),document.body.addEventListener("touchmove",this._onTouchMove.bind(this)),document.body.addEventListener("touchend",this._onTouchEnd.bind(this))),a.appendChild(o)};return i.prototype.getName=function(){return this._name},i.prototype._closest=function(e,t){return e&&(t(e)&&e!==this.chart?e:this._closest(e.parentNode,t))},i.prototype._siblings=function(e,t){return n(e.parentNode.children).filter(function(n){return n!==e&&(!t||e.matches(t))})},i.prototype._prevAll=function(e,t){for(var n=[],i=e.previousElementSibling;i;)t&&!i.matches(t)||n.push(i),i=i.previousElementSibling;return n},i.prototype._nextAll=function(e,t){for(var n=[],i=e.nextElementSibling;i;)t&&!i.matches(t)||n.push(i),i=i.nextElementSibling;return n},i.prototype._isVisible=function(e){return null!==e.offsetParent},i.prototype._addClass=function(e,t){e.forEach(function(e){t.indexOf(" ")>0?t.split(" ").forEach(function(t){return e.classList.add(t)}):e.classList.add(t)})},i.prototype._removeClass=function(e,t){e.forEach(function(e){t.indexOf(" ")>0?t.split(" ").forEach(function(t){return e.classList.remove(t)}):e.classList.remove(t)})},i.prototype._css=function(e,t,n){e.forEach(function(e){e.style[t]=n})},i.prototype._removeAttr=function(e,t){e.forEach(function(e){e.removeAttribute(t)})},i.prototype._one=function(e,t,n,i){var s=function(r){try{n.call(i,r)}finally{e.removeEventListener(t,s)}};e.addEventListener(t,s)},i.prototype._getDescElements=function(e,t){var n=[];return e.forEach(function(e){n.push(e.querySelectorAll(t))}),n},i.prototype._getJSON=function(e){return new Promise(function(t,n){var i=new XMLHttpRequest;i.open("GET",e),i.onreadystatechange=function(){4===this.readyState&&(200===this.status?t(JSON.parse(this.response)):n(new Error(this.statusText)))},i.responseType="json",i.setRequestHeader("Content-Type","application/json"),i.send()})},i.prototype._buildJsonDS=function(e){var t={name:e.firstChild.textContent.trim(),relationship:("LI"===e.parentNode.parentNode.nodeName?"1":"0")+(e.parentNode.children.length>1?1:0)+(e.children.length?1:0)};return e.id&&(t.id=e.id),e.querySelector("ul")&&n(e.querySelector("ul").children).forEach(function(e){t.children||(t.children=[]),t.children.push(this._buildJsonDS(e))}),t},i.prototype._attachRel=function(e,t){if(e.relationship=t+(e.children&&e.children.length>0?1:0),e.children)for(var n in e.children)this._attachRel(n,"1"+(e.children.length>1?1:0));return e},i.prototype._repaint=function(e){e&&(e.style.offsetWidth=e.offsetWidth)},i.prototype._isInAction=function(e){return e.querySelector(".edge").className.indexOf("fa-")>-1},i.prototype._getNodeState=function(e,t){var n,i={exist:!1,visible:!1};if("parent"===t)(n=this._closest(e,function(e){return e.classList&&e.classList.contains("nodes")}))&&(i.exist=!0),i.exist&&this._isVisible(n.parentNode.children[0])&&(i.visible=!0);else if("children"===t)(n=this._closest(e,function(e){return"TR"===e.nodeName}).nextElementSibling)&&(i.exist=!0),i.exist&&this._isVisible(n)&&(i.visible=!0);else if("siblings"===t){(n=this._siblings(this._closest(e,function(e){return"TABLE"===e.nodeName}).parentNode)).length&&(i.exist=!0);var s=this;i.exist&&n.some(function(e){return s._isVisible(e)})&&(i.visible=!0)}return i},i.prototype.getRelatedNodes=function(e,t){return"parent"===t?this._closest(e,function(e){return e.classList.contains("nodes")}).parentNode.children[0].querySelector(".node"):"children"===t?n(this._closest(e,function(e){return"TABLE"===e.nodeName}).lastChild.children).map(function(e){return e.querySelector(".node")}):"siblings"===t?this._siblings(this._closest(e,function(e){return"TABLE"===e.nodeName}).parentNode).map(function(e){return e.querySelector(".node")}):[]},i.prototype._switchHorizontalArrow=function(e){var t=this.options,n=e.querySelector(".leftEdge"),i=e.querySelector(".rightEdge"),s=this._closest(e,function(e){return"TABLE"===e.nodeName}).parentNode;if(t.toggleSiblingsResp&&(void 0===t.ajaxURL||this._closest(e,function(e){return e.classList.contains(".nodes")}).dataset.siblingsLoaded)){var r=s.previousElementSibling,o=s.nextElementSibling;r&&(r.classList.contains("hidden")?(n.classList.add("fa-chevron-left"),n.classList.remove("fa-chevron-right")):(n.classList.add("fa-chevron-right"),n.classList.remove("fa-chevron-left"))),o&&(o.classList.contains("hidden")?(i.classList.add("fa-chevron-right"),i.classList.remove("fa-chevron-left")):(i.classList.add("fa-chevron-left"),i.classList.remove("fa-chevron-right")))}else{var a=this._siblings(s),l=!!a.length&&!a.some(function(e){return e.classList.contains("hidden")});n.classList.toggle("fa-chevron-right",l),n.classList.toggle("fa-chevron-left",!l),i.classList.toggle("fa-chevron-left",l),i.classList.toggle("fa-chevron-right",!l)}},i.prototype._hoverNode=function(e){var t=e.target,i=!1,s=t.querySelector(".topEdge"),r=t.querySelector(".bottomEdge"),o=t.querySelector(".leftEdge");"mouseenter"===e.type?(s&&(i=this._getNodeState(t,"parent").visible,s.classList.toggle("fa-chevron-up",!i),s.classList.toggle("fa-chevron-down",i)),r&&(i=this._getNodeState(t,"children").visible,r.classList.toggle("fa-chevron-down",!i),r.classList.toggle("fa-chevron-up",i)),o&&this._switchHorizontalArrow(t)):n(t.querySelectorAll(".edge")).forEach(function(e){e.classList.remove("fa-chevron-up","fa-chevron-down","fa-chevron-right","fa-chevron-left")})},i.prototype._clickNode=function(e){var t=e.currentTarget,n=this.chart.querySelector(".focused");n&&n.classList.remove("focused"),t.classList.add("focused")},i.prototype._buildParentNode=function(e,t,n){var i=this,s=document.createElement("table");t.relationship=t.relationship||"001",this._createNode(t,0).then(function(e){var t=i.chart;e.classList.remove("slide-up"),e.classList.add("slide-down");var r=document.createElement("tr"),o=document.createElement("tr"),a=document.createElement("tr"),l=document.createElement("tr");r.setAttribute("class","hidden"),r.innerHTML='<td colspan="2"></td>',s.appendChild(r),o.setAttribute("class","lines hidden"),o.innerHTML='<td colspan="2"><div class="downLine"></div></td>',s.appendChild(o),a.setAttribute("class","lines hidden"),a.innerHTML='<td class="rightLine">&nbsp;</td><td class="leftLine">&nbsp;</td>',s.appendChild(a),l.setAttribute("class","nodes"),l.innerHTML='<td colspan="2"></td>',s.appendChild(l),s.querySelector("td").appendChild(e),t.insertBefore(s,t.children[0]),s.children[3].children[0].appendChild(t.lastChild),n()}).catch(function(e){console.error("Failed to create parent node",e)})},i.prototype._switchVerticalArrow=function(e){e.classList.toggle("fa-chevron-up"),e.classList.toggle("fa-chevron-down")},i.prototype.showParent=function(e){var t=this._prevAll(this._closest(e,function(e){return e.classList.contains("nodes")}));this._removeClass(t,"hidden"),this._addClass(Array(t[0].children).slice(1,-1),"hidden");var n=t[2].querySelector(".node");this._one(n,"transitionend",function(){n.classList.remove("slide"),this._isInAction(e)&&this._switchVerticalArrow(e.querySelector(".topEdge"))},this),this._repaint(n),n.classList.add("slide"),n.classList.remove("slide-down")},i.prototype.showSiblings=function(e,t){var i=[],s=this._closest(e,function(e){return"TABLE"===e.nodeName}).parentNode;i=t?"left"===t?this._prevAll(s):this._nextAll(s):this._siblings(s),this._removeClass(i,"hidden");var r=this._prevAll(this._closest(e,function(e){return e.classList.contains("nodes")}));if(s=n(r[0].querySelectorAll(".hidden")),t?this._removeClass(s.slice(0,2*i.length),"hidden"):this._removeClass(s,"hidden"),!this._getNodeState(e,"parent").visible){this._removeClass(r,"hidden");var o=r[2].querySelector(".node");this._one(o,"transitionend",function(e){e.target.classList.remove("slide")},this),this._repaint(o),o.classList.add("slide"),o.classList.remove("slide-down")}var a=this;i.forEach(function(e){n(e.querySelectorAll(".node")).forEach(function(e){a._isVisible(e)&&(e.classList.add("slide"),e.classList.remove("slide-left","slide-right"))})}),this._one(i[0].querySelector(".slide"),"transitionend",function(){i.forEach(function(e){a._removeClass(n(e.querySelectorAll(".slide")),"slide")}),this._isInAction(e)&&(this._switchHorizontalArrow(e),e.querySelector(".topEdge").classList.remove("fa-chevron-up"),e.querySelector(".topEdge").classList.add("fa-chevron-down"))},this)},i.prototype.hideSiblings=function(e,t){var i=this._closest(e,function(e){return"TABLE"===e.nodeName}).parentNode,s=this;this._siblings(i).forEach(function(e){e.querySelector(".spinner")&&(s.chart.dataset.inAjax=!1)}),(!t||t&&"left"===t)&&this._prevAll(i).forEach(function(e){n(e.querySelectorAll(".node")).forEach(function(e){s._isVisible(e)&&e.classList.add("slide","slide-right")})}),(!t||t&&"left"!==t)&&this._nextAll(i).forEach(function(e){n(e.querySelectorAll(".node")).forEach(function(e){s._isVisible(e)&&e.classList.add("slide","slide-left")})});var r=[];this._siblings(i).forEach(function(e){Array.prototype.push.apply(r,n(e.querySelectorAll(".slide")))});var o=[];for(var e in r){var a=this._closest(e,function(e){return e.classList.contains("nodes")}).previousElementSibling;o.push(a),o.push(a.previousElementSibling)}(o=o.concat(new Set(o))).forEach(function(e){e.style.visibility="hidden"}),this._one(r[0],"transitionend",function(a){o.forEach(function(e){e.removeAttribute("style")});var l=[];l=t?"left"===t?s._prevAll(i,":not(.hidden)"):s._nextAll(i,":not(.hidden)"):s._siblings(i);var d=n(s._closest(i,function(e){return e.classList.contains("nodes")}).previousElementSibling.querySelectorAll(":not(.hidden)")).slice(1,t?2*l.length+1:-1);s._addClass(d,"hidden"),s._removeClass(r,"slide"),l.forEach(function(e){n(e.querySelectorAll(".node")).slice(1).forEach(function(e){s._isVisible(e)&&(e.classList.remove("slide-left","slide-right"),e.classList.add("slide-up"))})}),l.forEach(function(e){s._addClass(n(e.querySelectorAll(".lines")),"hidden"),s._addClass(n(e.querySelectorAll(".nodes")),"hidden"),s._addClass(n(e.querySelectorAll(".verticalNodes")),"hidden")}),s._addClass(l,"hidden"),s._isInAction(e)&&s._switchHorizontalArrow(e)},this)},i.prototype.hideParent=function(e){var t=n(this._closest(e,function(e){return e.classList.contains("nodes")}).parentNode.children).slice(0,3);t[0].querySelector(".spinner")&&(this.chart.dataset.inAjax=!1),this._getNodeState(e,"siblings").visible&&this.hideSiblings(e);var i=t.slice(1);this._css(i,"visibility","hidden");var s=t[0].querySelector(".node"),r=this._getNodeState(s,"parent").visible;s&&this._isVisible(s)&&(s.classList.add("slide","slide-down"),this._one(s,"transitionend",function(){s.classList.remove("slide"),this._removeAttr(i,"style"),this._addClass(t,"hidden")},this)),s&&r&&this.hideParent(s)},i.prototype.addParent=function(e,t){var n=this;this._buildParentNode(e,t,function(){if(!e.querySelector(".topEdge")){var t=document.createElement("i");t.setAttribute("class","edge verticalEdge topEdge fa"),e.appendChild(t)}n.showParent(e)})},i.prototype._startLoading=function(e,t){var i=this.options,s=this.chart;if(void 0!==s.dataset.inAjax&&"true"===s.dataset.inAjax)return!1;e.classList.add("hidden");var r=document.createElement("i");r.setAttribute("class","fa fa-circle-o-notch fa-spin spinner"),t.appendChild(r),this._addClass(n(t.querySelectorAll("*:not(.spinner)")),"hazy"),s.dataset.inAjax=!0;var o=this.chartContainer.querySelector(".oc-export-btn"+(""!==i.chartClass?"."+i.chartClass:""));return o&&(o.disabled=!0),!0},i.prototype._endLoading=function(t,i){var s=this.options;t.classList.remove("hidden"),e(i.querySelector(".spinner")),this._removeClass(n(i.querySelectorAll(".hazy")),"hazy"),this.chart.dataset.inAjax=!1;var r=this.chartContainer.querySelector(".oc-export-btn"+(""!==s.chartClass?"."+s.chartClass:""));r&&(r.disabled=!1)},i.prototype._clickTopEdge=function(e){e.stopPropagation();var t=this,n=e.target,i=n.parentNode,s=this._getNodeState(i,"parent"),r=this.options;if(s.exist){var o=this._closest(i,function(e){return e.classList.contains("nodes")}).parentNode.firstChild.querySelector(".node");if(o.classList.contains("slide"))return;s.visible?(this.hideParent(i),this._one(o,"transitionend",function(){this._isInAction(i)&&(this._switchVerticalArrow(n),this._switchHorizontalArrow(i))},this)):this.showParent(i)}else{var a=n.parentNode.id;this._startLoading(n,i)&&this._getJSON("function"==typeof r.ajaxURL.parent?r.ajaxURL.parent(i.dataset.source):r.ajaxURL.parent+a).then(function(e){"true"===t.chart.dataset.inAjax&&Object.keys(e).length&&t.addParent(i,e)}).catch(function(e){console.error("Failed to get parent node data.",e)}).finally(function(){t._endLoading(n,i)})}},i.prototype.hideChildren=function(e){var t=this,i=this._nextAll(e.parentNode.parentNode),s=i[i.length-1],r=[];s.querySelector(".spinner")&&(this.chart.dataset.inAjax=!1);var o=n(s.querySelectorAll(".node")).filter(function(e){return t._isVisible(e)}),a=s.classList.contains("verticalNodes");a||(o.forEach(function(e){Array.prototype.push.apply(r,t._prevAll(t._closest(e,function(e){return e.classList.contains("nodes")}),".lines"))}),r=r.concat(new Set(r)),this._css(r,"visibility","hidden")),this._one(o[0],"transitionend",function(l){this._removeClass(o,"slide"),a?t._addClass(i,"hidden"):(r.forEach(function(e){e.removeAttribute("style"),e.classList.add("hidden"),e.parentNode.lastChild.classList.add("hidden")}),this._addClass(n(s.querySelectorAll(".verticalNodes")),"hidden")),this._isInAction(e)&&this._switchVerticalArrow(e.querySelector(".bottomEdge"))},this),this._addClass(o,"slide slide-up")},i.prototype.showChildren=function(e){var t=this,i=this._nextAll(e.parentNode.parentNode),s=[];this._removeClass(i,"hidden"),i.some(function(e){return e.classList.contains("verticalNodes")})?i.forEach(function(e){Array.prototype.push.apply(s,n(e.querySelectorAll(".node")).filter(function(e){return t._isVisible(e)}))}):n(i[2].children).forEach(function(e){Array.prototype.push.apply(s,n(e.querySelector("tr").querySelectorAll(".node")).filter(function(e){return t._isVisible(e)}))}),this._repaint(s[0]),this._one(s[0],"transitionend",function(n){t._removeClass(s,"slide"),t._isInAction(e)&&t._switchVerticalArrow(e.querySelector(".bottomEdge"))},this),this._addClass(s,"slide"),this._removeClass(s,"slide-up")},i.prototype._buildChildNode=function(e,t,n){var i=t.children||t.siblings;e.querySelector("td").setAttribute("colSpan",2*i.length),this.buildHierarchy(e,{children:i},0,n)},i.prototype.addChildren=function(e,t){var n=this,i=this.options,s=0;this.chart.dataset.inEdit="addChildren",this._buildChildNode.call(this,this._closest(e,function(e){return"TABLE"===e.nodeName}),t,function(){if(++s===t.children.length){if(!e.querySelector(".bottomEdge")){var r=document.createElement("i");r.setAttribute("class","edge verticalEdge bottomEdge fa"),e.appendChild(r)}if(!e.querySelector(".symbol")){var o=document.createElement("i");o.setAttribute("class","fa "+i.parentNodeSymbol+" symbol"),e.querySelector(".title").appendChild(o)}n.showChildren(e),n.chart.dataset.inEdit=""}})},i.prototype._clickBottomEdge=function(e){e.stopPropagation();var t=this,i=this.options,s=e.target,r=s.parentNode,o=this._getNodeState(r,"children");if(o.exist){var a=this._closest(r,function(e){return"TR"===e.nodeName}).parentNode.lastChild;if(n(a.querySelectorAll(".node")).some(function(e){return this._isVisible(e)&&e.classList.contains("slide")}))return;o.visible?this.hideChildren(r):this.showChildren(r)}else{var l=s.parentNode.id;this._startLoading(s,r)&&this._getJSON("function"==typeof i.ajaxURL.children?i.ajaxURL.children(r.dataset.source):i.ajaxURL.children+l).then(function(e){"true"===t.chart.dataset.inAjax&&e.children.length&&t.addChildren(r,e)}).catch(function(e){console.error("Failed to get children nodes data",e)}).finally(function(){t._endLoading(s,r)})}},i.prototype._complementLine=function(e,t,n){var i=e.parentNode.parentNode.children;i[0].children[0].setAttribute("colspan",2*t),i[1].children[0].setAttribute("colspan",2*t);for(var s=0;s<n;s++){var r=document.createElement("td"),o=document.createElement("td");r.setAttribute("class","rightLine topLine"),r.innerHTML="&nbsp;",i[2].insertBefore(r,i[2].children[1]),o.setAttribute("class","leftLine topLine"),o.innerHTML="&nbsp;",i[2].insertBefore(o,i[2].children[1])}},i.prototype._buildSiblingNode=function(t,i,s){var r=this,o=i.siblings?i.siblings.length:i.children.length,a="TD"===t.parentNode.nodeName?this._closest(t,function(e){return"TR"===e.nodeName}).children.length:1,l=a+o,d=l>1?Math.floor(l/2-1):0;if("TD"===t.parentNode.nodeName){var c=this._prevAll(t.parentNode.parentNode);e(c[0]),e(c[1]);var h=0;r._buildChildNode.call(r,r._closest(t.parentNode,function(e){return"TABLE"===e.nodeName}),i,function(){if(++h===o){var i=n(r._closest(t.parentNode,function(e){return"TABLE"===e.nodeName}).lastChild.children);if(a>1){c=t.parentNode.parentNode;n(c.children).forEach(function(e){i[0].parentNode.insertBefore(e,i[0])}),e(c),r._complementLine(i[0],l,a),r._addClass(i,"hidden"),i.forEach(function(e){r._addClass(e.querySelectorAll(".node"),"slide-left")})}else{var c=t.parentNode.parentNode;i[d].parentNode.insertBefore(t.parentNode,i[d+1]),e(c),r._complementLine(i[d],l,1),r._addClass(i,"hidden"),r._addClass(r._getDescElements(i.slice(0,d+1),".node"),"slide-right"),r._addClass(r._getDescElements(i.slice(d+1),".node"),"slide-left")}s()}})}else{var u=0;r.buildHierarchy.call(r,r.chart,i,0,function(){if(++u===l){var e=t.nextElementSibling.children[3].children[d],i=document.createElement("td");i.setAttribute("colspan",2),i.appendChild(t),e.parentNode.insertBefore(i,e.nextElementSibling),r._complementLine(e,l,1);var o=r._closest(t,function(e){return e.classList&&e.classList.contains("nodes")}).parentNode.children[0];o.classList.add("hidden"),r._addClass(n(o.querySelectorAll(".node")),"slide-down");var a=this._siblings(t.parentNode);r._addClass(a,"hidden"),r._addClass(r._getDescElements(a.slice(0,d),".node"),"slide-right"),r._addClass(r._getDescElements(a.slice(d),".node"),"slide-left"),s()}})}},i.prototype.addSiblings=function(e,t){var n=this;this.chart.dataset.inEdit="addSiblings",this._buildSiblingNode.call(this,this._closest(e,function(e){return"TABLE"===e.nodeName}),t,function(){if(n._closest(e,function(e){return e.classList&&e.classList.contains("nodes")}).dataset.siblingsLoaded=!0,!e.querySelector(".leftEdge")){var t=document.createElement("i"),i=document.createElement("i");t.setAttribute("class","edge horizontalEdge rightEdge fa"),e.appendChild(t),i.setAttribute("class","edge horizontalEdge leftEdge fa"),e.appendChild(i)}n.showSiblings(e),n.chart.dataset.inEdit=""})},i.prototype.removeNodes=function(t){var i=this._closest(t,function(e){return"TABLE"===e.nodeName}).parentNode,s=this._siblings(i.parentNode);"TD"===i.nodeName?this._getNodeState(t,"siblings").exist?(e(s[2].querySelector(".topLine").nextElementSibling),e(s[2].querySelector(".topLine")),s[0].children[0].setAttribute("colspan",s[2].children.length),s[1].children[0].setAttribute("colspan",s[2].children.length),e(i)):(s[0].children[0].removeAttribute("colspan"),e(s[0].querySelector(".bottomEdge")),this._siblings(s[0]).forEach(function(t){e(t)})):n(i.parentNode.children).forEach(function(t){e(t)})},i.prototype._clickHorizontalEdge=function(e){e.stopPropagation();var t=this,n=this.options,i=e.target,s=i.parentNode,r=this._getNodeState(s,"siblings");if(r.exist){var o=this._closest(s,function(e){return"TABLE"===e.nodeName}).parentNode;if(this._siblings(o).some(function(e){var n=e.querySelector(".node");return t._isVisible(n)&&n.classList.contains("slide")}))return;if(n.toggleSiblingsResp){var a=this._closest(s,function(e){return"TABLE"===e.nodeName}).parentNode.previousElementSibling,l=this._closest(s,function(e){return"TABLE"===e.nodeName}).parentNode.nextElementSibling;i.classList.contains("leftEdge")?a.classList.contains("hidden")?this.showSiblings(s,"left"):this.hideSiblings(s,"left"):l.classList.contains("hidden")?this.showSiblings(s,"right"):this.hideSiblings(s,"right")}else r.visible?this.hideSiblings(s):this.showSiblings(s)}else{var d=i.parentNode.id,c=this._getNodeState(s,"parent").exist?"function"==typeof n.ajaxURL.siblings?n.ajaxURL.siblings(JSON.parse(s.dataset.source)):n.ajaxURL.siblings+d:"function"==typeof n.ajaxURL.families?n.ajaxURL.families(JSON.parse(s.dataset.source)):n.ajaxURL.families+d;this._startLoading(i,s)&&this._getJSON(c).then(function(e){"true"===t.chart.dataset.inAjax&&(e.siblings||e.children)&&t.addSiblings(s,e)}).catch(function(e){console.error("Failed to get sibling nodes data",e)}).finally(function(){t._endLoading(i,s)})}},i.prototype._clickToggleButton=function(e){var t=this,i=e.target,s=i.parentNode.nextElementSibling,r=n(s.querySelectorAll(".node")),o=n(s.children).map(function(e){return e.querySelector(".node")});o.some(function(e){return e.classList.contains("slide")})||(i.classList.toggle("fa-plus-square"),i.classList.toggle("fa-minus-square"),r[0].classList.contains("slide-up")?(s.classList.remove("hidden"),this._repaint(o[0]),this._addClass(o,"slide"),this._removeClass(o,"slide-up"),this._one(o[0],"transitionend",function(){t._removeClass(o,"slide")})):(this._addClass(r,"slide slide-up"),this._one(r[0],"transitionend",function(){t._removeClass(r,"slide"),r.forEach(function(e){t._closest(e,function(e){return"UL"===e.nodeName}).classList.add("hidden")})}),r.forEach(function(e){var i=n(e.querySelectorAll(".toggleBtn"));t._removeClass(i,"fa-minus-square"),t._addClass(i,"fa-plus-square")})))},i.prototype._dispatchClickEvent=function(e){var t=e.target.classList;t.contains("topEdge")?this._clickTopEdge(e):t.contains("rightEdge")||t.contains("leftEdge")?this._clickHorizontalEdge(e):t.contains("bottomEdge")?this._clickBottomEdge(e):t.contains("toggleBtn")?this._clickToggleButton(e):this._clickNode(e)},i.prototype._onDragStart=function(e){var t=e.target,i=this.options,s=/firefox/.test(window.navigator.userAgent.toLowerCase());if(s&&e.dataTransfer.setData("text/html","hack for firefox"),this.chart.style.transform){var r,o;document.querySelector(".ghost-node")?o=(r=this.chart.querySelector(".ghost-node")).children[0]:((r=document.createElementNS("http://www.w3.org/2000/svg","svg")).classList.add("ghost-node"),o=document.createElementNS("http://www.w3.org/2000/svg","rect"),r.appendChild(o),this.chart.appendChild(r));var a=this.chart.style.transform.split(","),l=Math.abs(window.parseFloat("t2b"===i.direction||"b2t"===i.direction?a[0].slice(a[0].indexOf("(")+1):a[1]));r.setAttribute("width",t.offsetWidth),r.setAttribute("height",t.offsetHeight),o.setAttribute("x",5*l),o.setAttribute("y",5*l),o.setAttribute("width",120*l),o.setAttribute("height",40*l),o.setAttribute("rx",4*l),o.setAttribute("ry",4*l),o.setAttribute("stroke-width",1*l);var d=e.offsetX*l,c=e.offsetY*l;if("l2r"===i.direction?(d=e.offsetY*l,c=e.offsetX*l):"r2l"===i.direction?(d=t.offsetWidth-e.offsetY*l,c=e.offsetX*l):"b2t"===i.direction&&(d=t.offsetWidth-e.offsetX*l,c=t.offsetHeight-e.offsetY*l),s){var h=document.createElement("img");h.src="data:image/svg+xml;utf8,"+(new XMLSerializer).serializeToString(r),e.dataTransfer.setDragImage(h,d,c),o.setAttribute("fill","rgb(255, 255, 255)"),o.setAttribute("stroke","rgb(191, 0, 0)")}else e.dataTransfer.setDragImage(r,d,c)}var u=e.target,p=this._closest(u,function(e){return e.classList&&e.classList.contains("nodes")});p&&p.parentNode&&(p=p.parentNode.children[0].querySelector(".node")),dragHier=n(this._closest(u,function(e){return"TABLE"===e.nodeName}).querySelectorAll(".node")),this.dragged=u,n(this.chart.querySelectorAll(".node")).forEach(function(e){-1===dragHier.indexOf(e)&&(i.dropCriteria?i.dropCriteria(u,p,e)&&e.classList.add("allowedDrop"):e.classList.add("allowedDrop"))})},i.prototype._onDragOver=function(e){e.currentTarget.classList.contains("allowedDrop")&&e.preventDefault()},i.prototype._onDragEnd=function(e){n(this.chart.querySelectorAll(".allowedDrop")).forEach(function(e){e.classList.remove("allowedDrop")})},i.prototype._onDrop=function(t){var i=t.currentTarget,s=this.chart,r=this.dragged,o=this._closest(r,function(e){return e.classList&&e.classList.contains("nodes")}).parentNode.children[0].children[0];if(this._removeClass(n(s.querySelectorAll(".allowedDrop")),"allowedDrop"),i.parentNode.parentNode.nextElementSibling){var a=window.parseInt(i.parentNode.colSpan)+2;if(i.parentNode.setAttribute("colspan",a),i.parentNode.parentNode.nextElementSibling.children[0].setAttribute("colspan",a),!r.querySelector(".horizontalEdge")){var l=document.createElement("i"),d=document.createElement("i");l.setAttribute("class","edge horizontalEdge rightEdge fa"),r.appendChild(l),d.setAttribute("class","edge horizontalEdge leftEdge fa"),r.appendChild(d)}var c=i.parentNode.parentNode.nextElementSibling.nextElementSibling,h=document.createElement("td"),u=document.createElement("td");h.setAttribute("class","leftLine topLine"),h.innerHTML="&nbsp;",c.insertBefore(h,c.children[1]),u.setAttribute("class","rightLine topLine"),u.innerHTML="&nbsp;",c.insertBefore(u,c.children[2]),c.nextElementSibling.appendChild(this._closest(r,function(e){return"TABLE"===e.nodeName}).parentNode);var p=this._siblings(this._closest(r,function(e){return"TABLE"===e.nodeName}).parentNode).map(function(e){return e.querySelector(".node")});if(1===p.length){var l=document.createElement("i"),d=document.createElement("i");l.setAttribute("class","edge horizontalEdge rightEdge fa"),p[0].appendChild(l),d.setAttribute("class","edge horizontalEdge leftEdge fa"),p[0].appendChild(d)}}else{var f=document.createElement("i");f.setAttribute("class","edge verticalEdge bottomEdge fa"),i.appendChild(f),i.parentNode.setAttribute("colspan",2);var g=this._closest(i,function(e){return"TABLE"===e.nodeName}),v=document.createElement("tr"),m=document.createElement("tr"),b=document.createElement("tr");v.setAttribute("class","lines"),v.innerHTML='<td colspan="2"><div class="downLine"></div></td>',g.appendChild(v),m.setAttribute("class","lines"),m.innerHTML='<td class="rightLine">&nbsp;</td><td class="leftLine">&nbsp;</td>',g.appendChild(m),b.setAttribute("class","nodes"),g.appendChild(b),n(r.querySelectorAll(".horizontalEdge")).forEach(function(e){r.removeChild(e)});var _=this._closest(r,function(e){return"TABLE"===e.nodeName}).parentNode;b.appendChild(_)}var y=window.parseInt(o.colSpan);if(y>2){o.setAttribute("colspan",y-2),o.parentNode.nextElementSibling.children[0].setAttribute("colspan",y-2);c=o.parentNode.nextElementSibling.nextElementSibling;e(c.children[1]),e(c.children[1]);var E=n(o.parentNode.parentNode.children[3].children).map(function(e){return e.querySelector(".node")});1===E.length&&(e(E[0].querySelector(".leftEdge")),e(E[0].querySelector(".rightEdge")))}else o.removeAttribute("colspan"),o.querySelector(".node").removeChild(o.querySelector(".bottomEdge")),n(o.parentNode.parentNode.children).slice(1).forEach(function(t){e(t)});if(window.ActiveXObject||"ActiveXObject"in window)(L=document.createEvent("HTMLEvents")).initEvent("nodedropped.strutchart",{detail:{draggedNode:r,dragZone:o.children[0],dropZone:i}},void 0),s.dispatchEvent(L);else{var L=new CustomEvent("nodedropped.strutchart",{detail:{draggedNode:r,dragZone:o.children[0],dropZone:i}});s.dispatchEvent(L)}},i.prototype._createNode=function(e,t){var n=this,i=this.options;return new Promise(function(s,r){if(e.children)for(var o in e.children)o.parentId=e.id;var a=document.createElement("div");delete e.children,a.dataset.source=JSON.stringify(e),e[i.nodeId]&&(a.id=e[i.nodeId]);var l,d=n.chart.dataset.inEdit;l=d?"addChildren"===d?" slide-up":"":t>=i.depth?" slide-up":"",a.setAttribute("class","node "+(e.className||"")+l),i.draggable&&a.setAttribute("draggable",!0),e.parentId&&a.setAttribute("data-parent",e.parentId);var c='<div class="title">'+e[i.nodeTitle]+"</div>";i.nodeContent&&(c=c+'<div class="content">'+e[i.nodeContent]+"</div>"),a.innerHTML=c;var h=e.relationship||"";if("object"==typeof e.relationship&&(h=e.relationship.children_num.toString()+e.relationship.parent_num.toString()+e.relationship.sibling_num.toString()),i.verticalDepth&&t+2>i.verticalDepth){if(t+1>=i.verticalDepth&&Number(h.substr(2,1))){var u=document.createElement("i"),p=t+1>=i.depth?"plus":"minus";u.setAttribute("class","toggleBtn fa fa-"+p+"-square"),a.appendChild(u)}}else{if(Number(h.substr(0,1))){var f=document.createElement("i");f.setAttribute("class","edge verticalEdge topEdge fa"),a.appendChild(f)}if(Number(h.substr(1,1))){var g=document.createElement("i"),v=document.createElement("i");g.setAttribute("class","edge horizontalEdge rightEdge fa"),a.appendChild(g),v.setAttribute("class","edge horizontalEdge leftEdge fa"),a.appendChild(v)}if(Number(h.substr(2,1))){var m=document.createElement("i"),b=document.createElement("i"),_=a.querySelector(".title");m.setAttribute("class","edge verticalEdge bottomEdge fa"),a.appendChild(m),b.setAttribute("class","fa "+i.parentNodeSymbol+" symbol"),_.insertBefore(b,_.children[0])}}a.addEventListener("mouseenter",n._hoverNode.bind(n)),a.addEventListener("mouseleave",n._hoverNode.bind(n)),a.addEventListener("click",n._dispatchClickEvent.bind(n)),i.draggable&&(a.addEventListener("dragstart",n._onDragStart.bind(n)),a.addEventListener("dragover",n._onDragOver.bind(n)),a.addEventListener("dragend",n._onDragEnd.bind(n)),a.addEventListener("drop",n._onDrop.bind(n))),i.createNode&&i.createNode(a,e),s(a)})},i.prototype.buildHierarchy=function(e,t,n,i){var s,r=this,o=this.options,a=t.children,l=o.verticalDepth&&n+1>=o.verticalDepth;if(Object.keys(t).length>1&&(s=l?e:document.createElement("table"),l||e.appendChild(s),this._createNode(t,n).then(function(e){if(l)s.insertBefore(e,s.firstChild);else{var t=document.createElement("tr"),n="<td ";a?n=n+"colspan="+2*a.length+"></td>":n+="></td>",t.innerHTML=n,t.children[0].appendChild(e),s.insertBefore(t,s.children[0]?s.children[0]:null)}i&&i()}).catch(function(n){console.log(e),console.log(t),console.error("Failed to creat node",n)})),a&&0!=a.length){1===Object.keys(t).length&&(s=e);var d,c=o.verticalDepth&&n+2>=o.verticalDepth,h=r.chart.dataset.inEdit;d=h?"addSiblings"===h?"":" hidden":n+1>=o.depth?" hidden":"",c||((g=document.createElement("tr")).setAttribute("class","lines"+d),g.innerHTML='<td colspan="'+2*a.length+'"><div class="downLine"></div></td>',s.appendChild(g));var u=document.createElement("tr");u.setAttribute("class","lines"+d);var p=a.slice(1).map(function(){return'<td class="leftLine topLine">&nbsp;</td><td class="rightLine topLine">&nbsp;</td>'}).join("");u.innerHTML='<td class="rightLine">&nbsp;</td> '+p+'<td class="leftLine">&nbsp;</td>';var f;if(c)if(f=document.createElement("ul"),d&&f.classList.add(d.trim()),n+2===o.verticalDepth){var g=document.createElement("tr");g.setAttribute("class","verticalNodes"+d),g.innerHTML="<td></td>",g.firstChild.appendChild(f),s.appendChild(g)}else s.appendChild(f);else(f=document.createElement("tr")).setAttribute("class","nodes"+d),s.appendChild(u),s.appendChild(f);a.forEach(function(e){var t;c?t=document.createElement("li"):(t=document.createElement("td")).setAttribute("colspan",2),f.appendChild(t),r.buildHierarchy(t,e,n+1,i)})}},i.prototype._clickChart=function(e){!this._closest(e.target,function(e){return e.classList&&e.classList.contains("node")})&&this.chart.querySelector(".node.focused")&&this.chart.querySelector(".node.focused").classList.remove("focused")},i.prototype._clickExportButton=function(){var e=this.options,t=this.chartContainer,n=t.querySelector(".mask"),i=t.querySelector(".strutchart:not(.hidden)"),s="l2r"===e.direction||"r2l"===e.direction;t.style.width=i.clientWidth+"px",t.style.height=i.clientHeight+"px",n?n.classList.remove("hidden"):((n=document.createElement("div")).setAttribute("class","mask"),n.innerHTML='<i class="fa fa-circle-o-notch fa-spin spinner"></i>',t.appendChild(n)),t.classList.add("canvasContainer"),window.html2canvas(i,{width:s?i.clientHeight:i.clientWidth,height:s?i.clientWidth:i.clientHeight,onclone:function(e){var t=e.querySelector(".canvasContainer");t.style.overflow="visible",t.querySelector(".strutchart:not(.hidden)").transform=""}}).then(function(e){var n=t.querySelector(".oc-download-btn");t.querySelector(".mask").classList.add("hidden"),n.setAttribute("href",e.toDataURL()),n.click()}).catch(function(e){console.error("Failed to export the curent strutchart!",e)}).finally(function(){t.classList.remove("canvasContainer"),t.style.width="auto",t.style.height="auto"})},i.prototype._loopChart=function(e){var t={id:e.querySelector(".node").id};return e.children[3]&&n(e.children[3].children).forEach(function(e){t.children||(t.children=[]),t.children.push(this._loopChart(e.firstChild))}),t},i.prototype.getHierarchy=function(){return this.chart.querySelector(".node").id?this._loopChart(this.chart.querySelector("table")):"Error: Nodes of orghcart to be exported must have id attribute!"},i.prototype._onPanStart=function(e){var t=e.currentTarget;if(this._closest(e.target,function(e){return e.classList&&e.classList.contains("node")})||e.touches&&e.touches.length>1)t.dataset.panning=!1;else{t.style.cursor="move",t.dataset.panning=!0;var n=0,i=0,s=window.getComputedStyle(t).transform;if("none"!==s){var r=s.split(",");s.includes("3d")?(n=Number.parseInt(r[12],10),i=Number.parseInt(r[13],10)):(n=Number.parseInt(r[4],10),i=Number.parseInt(r[5],10))}var o=0,a=0;if(e.targetTouches){if(1===e.targetTouches.length)o=e.targetTouches[0].pageX-n,a=e.targetTouches[0].pageY-i;else if(e.targetTouches.length>1)return}else o=e.pageX-n,a=e.pageY-i;t.dataset.panStart=JSON.stringify({startX:o,startY:a}),t.addEventListener("mousemove",this._onPanning.bind(this)),t.addEventListener("touchmove",this._onPanning.bind(this))}},i.prototype._onPanning=function(e){var t=e.currentTarget;if("false"!==t.dataset.panning){var n=0,i=0,s=JSON.parse(t.dataset.panStart),r=s.startX,o=s.startY;if(e.targetTouches){if(1===e.targetTouches.length)n=e.targetTouches[0].pageX-r,i=e.targetTouches[0].pageY-o;else if(e.targetTouches.length>1)return}else n=e.pageX-r,i=e.pageY-o;var a=window.getComputedStyle(t).transform;if("none"===a)a.includes("3d")?t.style.transform="matrix3d(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, "+n+", "+i+", 0, 1)":t.style.transform="matrix(1, 0, 0, 1, "+n+", "+i+")";else{var l=a.split(",");a.includes("3d")?(l[12]=n,l[13]=i):(l[4]=n,l[5]=i+")"),t.style.transform=l.join(",")}}},i.prototype._onPanEnd=function(e){var t=this.chart;"true"===t.dataset.panning&&(t.dataset.panning=!1,t.style.cursor="default",document.body.removeEventListener("mousemove",this._onPanning),document.body.removeEventListener("touchmove",this._onPanning))},i.prototype._setChartScale=function(e,t){var n=window.getComputedStyle(e).transform;if("none"===n)e.style.transform="scale("+t+","+t+")";else{var i=n.split(",");n.includes("3d")?e.style.transform=n+" scale3d("+t+","+t+", 1)":(i[0]="matrix("+t,i[3]=t,e.style.transform=n+" scale("+t+","+t+")")}e.dataset.scale=t},i.prototype._onWheeling=function(e){var t=e.deltaY>0?.8:1.2;this._setChartScale(this.chart,t),e.preventDefault()},i.prototype._getPinchDist=function(e){return Math.sqrt((e.touches[0].clientX-e.touches[1].clientX)*(e.touches[0].clientX-e.touches[1].clientX)+(e.touches[0].clientY-e.touches[1].clientY)*(e.touches[0].clientY-e.touches[1].clientY))},i.prototype._onTouchStart=function(e){var t=this.chart;if(e.touches&&2===e.touches.length){var n=this._getPinchDist(e);t.dataset.pinching=!0,t.dataset.pinchDistStart=n}},i.prototype._onTouchMove=function(e){var t=this.chart;if(t.dataset.pinching){var n=this._getPinchDist(e);t.dataset.pinchDistEnd=n}},i.prototype._onTouchEnd=function(e){var t=this.chart;if(t.dataset.pinching){t.dataset.pinching=!1;var n=t.dataset.pinchDistEnd-t.dataset.pinchDistStart;n>0?this._setChartScale(t,1):n<0&&this._setChartScale(t,-1)}},i});